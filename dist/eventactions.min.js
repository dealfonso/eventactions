/* Copyright 2023 Carlos A. (https://github.com/dealfonso); License: https://opensource.org/license/mit/ */
(function(exports){if(typeof exports==="undefined"){exports=window}const DEFAULT_OPTIONS_ACTION={condition:null,conditionAction:null,confirm:null,confirmAcceptText:"OK",confirmCancelText:"Cancel",execute:null,target:null,targetChildren:null,classAdd:null,classRemove:null,classToggle:null,classSet:null,scrollTo:null,contentMethod:"innerHTML",contentSet:null,contentAppend:null,contentPrepend:null,contentClear:null,delay:0,acknowledge:null,acknowledgeButton:"OK",splash:null};async function executeAction(el,actionOptions){actionOptions=Object.assign({},EventActions.defaultActionOptions,actionOptions||{});let targetElements=[];const targetSelector=sanitizeValue(actionOptions.target||null);const targetChildrenSelector=sanitizeValue(actionOptions.targetChildren||null);if(targetSelector===null&&targetChildrenSelector===null){targetElements=[el]}else{if(targetSelector){try{targetElements=[...targetElements,...document.querySelectorAll(targetSelector)]}catch(error){console.warn(`Error selecting elements with selector "${targetSelector}"`,error)}}if(targetChildrenSelector){try{targetElements=[...targetElements,...el.querySelectorAll(targetChildrenSelector)]}catch(error){console.warn(`Error selecting children with selector "${targetChildrenSelector}"`,error)}}}const condition=sanitizeValue(actionOptions.condition||null);if(condition){if(typeof condition==="function"){result=condition.bind(el)(targetElements);if(!result){return false}return true}try{let result=function(){return eval(condition)}.bind(el)(targetElements);if(typeof result==="function"){result=result.bind(el)(targetElements)}if(!result){return false}}catch(error){console.error(`Error evaluating condition "${condition}":`,error);return false}}const conditionAction=sanitizeValue(actionOptions.conditionAction||null);let shouldSkipAction=false;if(conditionAction){if(typeof conditionAction==="function"){result=conditionAction.bind(el)(targetElements);if(!result){return true}}try{let result=function(){return eval(conditionAction)}.bind(el)(targetElements);if(typeof result==="function"){result=result.bind(el)(targetElements)}if(!result){shouldSkipAction=true}}catch(error){console.error(`Error evaluating action condition "${conditionAction}":`,error);shouldSkipAction=true}}if(shouldSkipAction){return true}const confirmMessage=sanitizeValue(actionOptions.confirm||null);if(confirmMessage){const confirmAcceptText=sanitizeValue(actionOptions.confirmAcceptText||"OK");const confirmCancelText=sanitizeValue(actionOptions.confirmCancelText||"Cancel");try{await confirmDialog(confirmMessage,confirmAcceptText,confirmCancelText)}catch(error){return false}}const execute=sanitizeValue(actionOptions.execute||null);if(execute){if(typeof execute==="function"){execute.bind(el)(targetElements)}else{try{let result=function(){return eval(execute)}.bind(el)();if(typeof result==="function"){result=result.bind(el)(targetElements)}}catch(error){console.error(`Error executing action "${execute}":`,error)}}}const classesAdd=sanitizeValue(actionOptions.classAdd||null);const classesRemove=sanitizeValue(actionOptions.classRemove||null);const classesToggle=sanitizeValue(actionOptions.classToggle||null);const classesSet=sanitizeValue(actionOptions.classSet||null);const classListAdd=classesAdd?classesAdd.split(/\s+/).filter(e=>e.trim()!==""):[];const classListRemove=classesRemove?classesRemove.split(/\s+/).filter(e=>e.trim()!==""):[];const classListToggle=classesToggle?classesToggle.split(/\s+/).filter(e=>e.trim()!==""):[];const classListSet=classesSet?classesSet.split(/\s+/).filter(e=>e.trim()!==""):[];const intersectionSR=classListAdd.filter(e=>classListRemove.includes(e));const intersectionST=classListAdd.filter(e=>classListToggle.includes(e));const intersectionRT=classListRemove.filter(e=>classListToggle.includes(e));if(intersectionSR.length>0||intersectionST.length>0||intersectionRT.length>0){console.warn("Cannot set, unset or toggle the same class at the same time:",{classListAdd:classListAdd,classListRemove:classListRemove,classListToggle:classListToggle});return false}let applyClasses=()=>{for(const t of targetElements){if(classListSet.length>0){t.classList.remove(...t.classList);classListSet.forEach(e=>{t.classList.add(e)});continue}if(classListToggle.length>0){classListToggle.forEach(e=>{t.classList.toggle(e)})}if(classListAdd.length>0){classListAdd.forEach(e=>{t.classList.add(e)})}if(classListRemove.length>0){classListRemove.forEach(e=>{t.classList.remove(e)})}}};const contentMethod=sanitizeValue(actionOptions.contentMethod||"innerHTML");if(!["innerHTML","textContent"].includes(contentMethod)){console.warn(`Invalid content method: ${contentMethod}`);return}const contentSet=sanitizeValue(actionOptions.contentSet||null);const contentAppend=sanitizeValue(actionOptions.contentAppend||null);const contentPrepend=sanitizeValue(actionOptions.contentPrepend||null);const contentClear=actionOptions.contentClear===true||actionOptions.contentClear==="true"||actionOptions.contentClear==="";let applyContentChanges=()=>{for(const e of targetElements){if(contentClear){e[contentMethod]=""}if(contentSet){e[contentMethod]=contentSet}if(contentAppend){e[contentMethod]+=contentAppend}if(contentPrepend){e[contentMethod]=contentPrepend+e[contentMethod]}}};const scrollTo=sanitizeValue(actionOptions.scrollTo||null);if(scrollTo&&!["top","bottom","left","right"].includes(scrollTo)){console.warn(`Invalid scroll-to value: ${scrollTo}`);scrollTo=null}let applyScroll=()=>{if(!scrollTo){return}for(const e of targetElements){switch(scrollTo){case"top":e.scrollTop=0;break;case"bottom":e.scrollTop=e.scrollHeight;break;case"left":e.scrollLeft=0;break;case"right":e.scrollLeft=e.scrollWidth;break}break}};const delay=parseFloat(actionOptions.delay)||0;if(delay>0&&!isNaN(delay)){await new Promise(e=>setTimeout(e,delay))}applyClasses();applyContentChanges();applyScroll();const acknowledgeMessage=sanitizeValue(actionOptions.acknowledge||null);const acknowledgeButton=sanitizeValue(actionOptions.acknowledgeButton||"OK");if(acknowledgeMessage){await messageDialog(acknowledgeMessage,acknowledgeButton)}return true}function removeEventActions(e,t=null){if(!e||!e._eventActions)return;if(!t){for(const n in e._eventActions){removeEventActions(e,n)}return}if(!e._eventActions[t])return;if(e._eventActions.handlers&&e._eventActions.handlers[t]){e.removeEventListener(t,e._eventActions.handlers[t]);delete e._eventActions.handlers[t]}if(e._eventActions[t]){e[`on${t}`]=e._eventActions[t];delete e._eventActions[t]}else{e[`on${t}`]=null}if(e._eventActions.handlers&&Object.keys(e._eventActions.handlers).length===0){delete e._eventActions}}function addEventActions(e,a="click",t="ca"){if(!e)return;if(e._eventActions&&e._eventActions[a])return;e._eventActions=e._eventActions||{};e._eventActions[a]=e[`on${a}`]||null;e[`on${a}`]=null;function n(i,c){let e=async function(e){e.preventDefault();e.stopPropagation();let t=true;let n=null;let o=getElementOptions(i,EventActions.defaultActionOptions,c,true);if(o&&Object.keys(o).length>0){o=Object.assign({},EventActions.defaultActionOptions,o||{});t=await executeAction(i,o);if(t&&o.splash){if(n){n.modal.hide();n=null}n=splashDialog(o.splash)}}let l=1;while(t){o=getElementOptions(i,EventActions.defaultActionOptions,`${c}-${l}`,true);if(o&&Object.keys(o).length>0){const s=o.splash===null||o.splash===""||o.splash==="false"||o.splash==="0"||o.splash===false;o=Object.assign({},EventActions.defaultActionOptions,o||{});t=await executeAction(i,o);if(s){if(n){n.modal.hide();n=null}}if(t&&o.splash){if(n){n.modal.hide();n=null}n=splashDialog(o.splash)}l++}else{break}}if(t){o=getElementOptions(i,EventActions.defaultActionOptions,`${c}-last`,true);if(o&&Object.keys(o).length>0){o=Object.assign({},EventActions.defaultActionOptions,o||{});await executeAction(i,o);if(o.splash===null){if(n){n.modal.hide();n=null}}if(t&&o.splash){if(n){n.modal.hide();n=null}n=splashDialog(o.splash)}}}o=getElementOptions(i,EventActions.defaultActionOptions,`${c}-finally`,true);if(o&&Object.keys(o).length>0){o=Object.assign({},EventActions.defaultActionOptions,o||{});await executeAction(i,o);if(o.splash===null){if(n){n.modal.hide();n=null}}if(t&&o.splash){if(n){n.modal.hide();n=null}n=splashDialog(o.splash)}}if(t){if(i._eventActions&&i._eventActions[a]){i._eventActions[a].bind(i)(e)}}if(n){n.modal.hide()}};return e}function o(e,t,n){e.addEventListener(t,n);e._eventActions.handlers=e._eventActions.handlers||{};e._eventActions.handlers[t]=n}o(e,a,n(e,t))}const EventActions={execute:executeAction,addEventActions:addEventActions,addClickActions:e=>addEventActions(e,"click","ca"),addScrollActions:e=>addEventActions(e,"scroll","sa"),removeEventActions:removeEventActions,removeClickActions:e=>removeEventActions(e,"click"),removeScrollActions:e=>removeEventActions(e,"scroll"),defaultActionOptions:DEFAULT_OPTIONS_ACTION,version:"1.0.0"};document.addEventListener("DOMContentLoaded",()=>{const e=Object.keys(EventActions.defaultActionOptions).map(e=>`[data-ca-${camelToSnakeCase(e)}],[data-ca-1-${camelToSnakeCase(e)}]`).join(",");const t=Object.keys(EventActions.defaultActionOptions).map(e=>`[data-sa-${camelToSnakeCase(e)}],[data-sa-1-${camelToSnakeCase(e)}]`).join(",");document.querySelectorAll(`${e}`).forEach(e=>{addEventActions(e,"click","ca")});document.querySelectorAll(`${t}`).forEach(e=>{addEventActions(e,"scroll","sa")})});exports.EventActions=EventActions;function snakeToCamelCase(e){return e.replace(/-([a-z])/g,e=>e[1].toUpperCase())}function camelToSnakeCase(e){e=e.replace(/([0-9]+)/g,e=>`-${e}`);e=e.replace(/[A-Z]/g,e=>`-${e[0].toLowerCase()}`);e=e.replace(/--+/g,"-");e=e.replace(/^-+/,"").replace(/-+$/,"");return e}function sanitizeValue(e){if(e===null||e===undefined){return null}if(typeof e!=="string"){return e}e=e.trim();if(e===""){return null}return e}function getElementOptions(e,t,n,o=false){let l={};const s=n?`${camelToSnakeCase(n)}-`:"";for(const i of Object.keys(t)){const c=s+camelToSnakeCase(i);const a=e.dataset[c]||e.getAttribute(`data-${c}`);if(a!==null&&a!==undefined){if(typeof t[i]==="boolean"){l[i]=a.toLowerCase()==="true"}else if(typeof t[i]==="number"){l[i]=parseFloat(a)}else{l[i]=a}}else{if(!o){l[i]=t[i]}}}return l}const DEFAULT_MODAL_OPTIONS={title:null,body:null,btnAcceptText:"Accept",btnCancelText:"Cancel",btnAcceptClass:"btn-primary",btnCancelClass:"btn-secondary",size:"md",centered:true,backdrop:"static",keyboard:true,focus:true,onAccept:null,onCancel:null,onShow:null,onShown:null,onHide:null,onHidden:null,autoShow:true};function confirmDialog(n,e="Accept",t="Cancel",o=null){const l=bsCreateModal({title:o,body:n,btnAcceptText:e,btnCancelText:t});if(!l){return new Promise((e,t)=>{if(window.confirm(n)){e(true)}else{t(false)}})}return l}function messageDialog(t,e="OK",n=null){const o=bsCreateModal({title:n,body:t,btnAcceptText:e,btnCancelText:null});if(!o){return new Promise(e=>{window.alert(t);e(true)})}return o}function splashDialog(e='<div class="spinner-border" role="status" aria-hidden="true"></div>',t=null){const n=bsCreateModal({title:t,body:e,btnAcceptText:null,btnCancelText:null,backdrop:"static",keyboard:false,focus:false});return n}function bsCreateModal(o={}){if(typeof bootstrap==="undefined"||!bootstrap.Modal){console.warn("bsCreateModal: Bootstrap 5 is required for this function to work.");return null}o=Object.assign({},DEFAULT_MODAL_OPTIONS,o||{});if(!o.title&&!o.body&&!o.btnAcceptText&&!o.btnCancelText){console.error("bsCreateModal: At least one of title, body, btnAcceptText or btnCancelText must be provided");return null}if(["sm","md","lg","xl","xxl"].indexOf(o.size)===-1){o.size="md"}if(o.size==="md"){o.size=""}else{o.size=`modal-${o.size}`}if(typeof o.centered!=="boolean"){o.centered=DEFAULT_MODAL_OPTIONS.centered}if(o.backdrop!==true&&o.backdrop!==false&&o.backdrop!=="static"){o.backdrop=DEFAULT_MODAL_OPTIONS.backdrop}if(typeof o.keyboard!=="boolean"){o.keyboard=DEFAULT_MODAL_OPTIONS.keyboard}if(typeof o.focus!=="boolean"){o.focus=DEFAULT_MODAL_OPTIONS.focus}if(o.btnAcceptText!==null&&typeof o.btnAcceptText!=="string"){o.btnAcceptText=DEFAULT_MODAL_OPTIONS.btnAcceptText}if(o.btnCancelText!==null&&typeof o.btnCancelText!=="string"){o.btnCancelText=DEFAULT_MODAL_OPTIONS.btnCancelText}if(o.autoShow!==true&&o.autoShow!==false){o.autoShow=DEFAULT_MODAL_OPTIONS.autoShow}o.btnAcceptText=sanitizeValue(o.btnAcceptText);o.btnCancelText=sanitizeValue(o.btnCancelText);o.title=sanitizeValue(o.title);o.body=sanitizeValue(o.body);if(o.onAccept&&typeof o.onAccept!=="function"){o.onAccept=null}if(o.onCancel&&typeof o.onCancel!=="function"){o.onCancel=null}if(o.onShow&&typeof o.onShow!=="function"){o.onShow=null}if(o.onShown&&typeof o.onShown!=="function"){o.onShown=null}if(o.onHide&&typeof o.onHide!=="function"){o.onHide=null}if(o.onHidden&&typeof o.onHidden!=="function"){o.onHidden=null}let l=document.createElement("div");l.innerHTML=`
<div class="modal ${o.size}" tabindex="-1" ${o.backdrop===false?'data-bs-backdrop="false"':o.backdrop==="static"?'data-bs-backdrop="static"':""} ${o.keyboard===false?'data-bs-keyboard="false"':""} ${o.focus===false?'data-bs-focus="false"':""}">
  <div class="modal-dialog ${o.centered?"modal-dialog-centered":""}">
    <div class="modal-content">
      ${o.title===null?"":`<div class="modal-header"><h5 class="modal-title">${o.title}</h5></div>`}
      ${o.body===null?"":`<div class="modal-body">${o.body}</div>`}
      ${o.btnAcceptText===null&&o.btnCancelText===null?"":`
      <div class="modal-footer">
        ${o.btnCancelText===null?"":`<button type="button" class="btn ${o.btnCancelClass}" data-bs-dismiss="modal">${o.btnCancelText}</button>`}
        ${o.btnAcceptText===null?"":`<button type="button" class="btn ${o.btnAcceptClass}">${o.btnAcceptText}</button>`}
      </div>`}
    </div>
  </div>
</div>`;const e=l.querySelector(".btn-primary");const s=l.querySelector(".btn-secondary");const i=l.querySelector(".modal");document.body.appendChild(l);const c=new bootstrap.Modal(i);o=Object.assign({},DEFAULT_MODAL_OPTIONS,o||{});const t=new Promise((t,n)=>{if(o.btnAcceptText){e.addEventListener("click",e=>{if(o.onAccept&&typeof o.onAccept==="function"){o.onAccept(e,i)}t("accept");c.hide()},{once:true})}if(o.btnCancelText){s.addEventListener("click",e=>{if(o.onCancel&&typeof o.onCancel==="function"){o.onCancel(e,i)}n("cancel");c.hide()},{once:true})}if(o.keyboard===true){i.addEventListener("keydown",e=>{if(e.key==="Escape"){if(o.onCancel&&typeof o.onCancel==="function"){o.onCancel(e,i)}n("cancel");c.hide()}},{once:true})}if(o.onShow&&typeof o.onShow==="function"){i.addEventListener("show.bs.modal",e=>{o.onShow(e,i)},{once:true})}if(o.onShown&&typeof o.onShown==="function"){i.addEventListener("shown.bs.modal",e=>{o.onShown(e,i)},{once:true})}if(o.onHide&&typeof o.onHide==="function"){i.addEventListener("hide.bs.modal",e=>{o.onHide(e,i)},{once:true})}if(o.onHidden&&typeof o.onHidden==="function"){i.addEventListener("hidden.bs.modal",e=>{o.onHidden(e,i)},{once:true})}i.addEventListener("hide.bs.modal",function(e){if(document.activeElement){document.activeElement.blur()}});i.addEventListener("hidden.bs.modal",e=>{c.dispose();l.remove()},{once:true})});c.show();t.modal=c;return t}})(window);